<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Muni L&F Hub</title>
  <link rel="icon" href="favicon.png" type="image/png"/>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.css"/>

  <!-- Styles: css-style layout -->
  <style>
    :root{
      --primary:#2c3e50;
      --secondary:#3498db;
      --accent:#e74c3c;
      --success:#2ecc71;
      --warning:#f39c12;
      --light:#ecf0f1;
      --dark:#2c3e50;
      --text:#2c3e50;
      --unapproved: #f39c12; /* Orange for unapproved */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;background:#f5f7fa;color:var(--text)}
    a{text-decoration:none;color:inherit}
    
    .searchbar input {
      flex: none; /* prevent stretching */
      width: 220px; /* fixed smaller width */
    }

    /* Top nav */
    header{background:#fff;border-bottom:1px solid #eaecef;position:sticky;top:0;z-index:100}
    .topbar{display:flex;align-items:center;gap:1rem;justify-content:space-between;max-width:1200px;margin:0 auto;padding:.75rem 1rem}
    .brand{display:flex;align-items:center;gap:.5rem}
    .brand img{width:40px;height:40px}
    .brand h1{font-size:1.25rem;color:var(--secondary);margin:0;font-weight:700}
    .searchbar{flex:1;display:flex;gap:.5rem}
    .searchbar input{flex:1;padding:.6rem .8rem;border:1px solid #dfe3e6;border-radius:6px}
    .searchbar button{background:var(--secondary);color:#fff;border:none;padding:.6rem .9rem;border-radius:6px;cursor:pointer}
    .userbox{display:flex;align-items:center;gap:.75rem}
    .userbox .user-email{color:var(--secondary);font-weight:600}
    .userbox .btn{color:#fff;background:var(--accent);padding:.5rem .8rem;border-radius:6px}

    /* Navigation Bar  */
    .navbar{background:linear-gradient(90deg,#2c3e50,#3498db);color:#fff}
    .navwrap{max-width:1200px;margin:0 auto;display:flex;gap:1.5rem;padding:.6rem 1rem;flex-wrap:wrap; justify-content: flex-start;}
    .nav-link{padding:.35rem .2rem;border:none;cursor:pointer;font-weight: 500; transition: text-decoration 0.2s;} 
    .nav-link:hover {text-decoration: underline;}

    /* Hero banner */
    .hero{max-width:1200px;margin:1rem auto;background:linear-gradient(rgba(44,62,80,.6),rgba(44,62,80,.6)),url('view.jpg') center/cover;border-radius:12px;color:#fff;padding:2rem 1rem;text-align:center}
    .hero h2{margin:0 0 .75rem}
    .hero .cta{display:inline-block;background:var(--accent);color:#fff;padding:.6rem 1rem;border-radius:24px;margin-top:.75rem}

    /* Page layout */
    main{max-width:1200px;margin:0 auto;padding:1rem}
    .grid-layout{display:grid;grid-template-columns:260px 1fr;gap:1rem}

    /* Left filters (Jumia-style sidebar) */
    .filters{background:#fff;border:1px solid #eaecef;border-radius:10px;padding:1rem}
    .filters h3{margin:.25rem 0 .75rem;color:var(--primary)}
    .filters .group{margin-bottom:1rem}
    .filters select,.filters input,.filters textarea{width:100%;padding:.5rem .6rem;border:1px solid #dfe3e6;border-radius:6px;margin-top: .3rem}
    .filters label{font-size: .9rem; color: #555;}
    .filters .sort{margin-top:.75rem}
    .filters #itemForm{display:none;} /* Hidden by default */

    /* Results header */
    .results-head{display:flex;justify-content:space-between;align-items:center;margin:.5rem 0;color:#555}

    /* Item cards grid */
    .items{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem}
    .card{background:#fff;border:1px solid #eaecef;border-radius:10px;overflow:hidden;transition:box-shadow .2s,transform .15s; position: relative;}
    .card:hover{box-shadow:0 10px 24px rgba(0,0,0,.08);transform:translateY(-2px)}
    
    .unapproved-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        color: var(--unapproved);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 1.1rem;
        text-align: center;
        border: 3px solid var(--unapproved);
        border-radius: 10px;
        padding: 1rem;
        z-index: 10;
    }
    .unapproved-overlay .btn-approve {
        background: var(--success);
        margin-top: 1rem;
        color: white;
    }

    .thumb{height:170px;background:#f0f3f6;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .info{padding:.8rem}
    .title{font-weight:600;color:var(--primary);margin:0 0 .25rem}
    .meta{display:flex;gap:.4rem;flex-wrap:wrap;font-size:.85rem;color:#666;margin:.35rem 0}
    .badge{padding:.15rem .45rem;border-radius:12px;background:#ecf0f1}
    .badge.status{color:#fff;background:var(--success)}
    .badge.status.lost{background:var(--warning)}
    .desc{color:#555;font-size:.92rem;margin:.5rem 0}
    .actions{display:flex;justify-content:space-between;align-items:center;margin-top:.5rem}
    .contact{color:var(--secondary);font-weight:600;font-size:.9rem}
    .btn{border:none;border-radius:6px;padding:.45rem .7rem;cursor:pointer}
    .btn-claim{background:var(--secondary);color:#fff}
    .btn-delete{background:var(--accent);color:#fff}
    .btn-contact-finder {background: var(--success); color: #fff;}


    /* Modal (auth + details) */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;align-items:center;justify-content:center}
    .modal .box{background:#fff;border-radius:10px;padding:1rem;max-width:420px;width:92%;position:relative;}
    .modal h3{margin:.25rem 0 1rem;text-align:center;}
    .modal .close{position:absolute;top:10px;right:12px;color:#777;cursor:pointer}
    
    /* Form Switch for Login/Signup */
    .form-switch {
      display: flex;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 1rem;
    }
    .form-switch button {
      flex: 1;
      padding: .75rem;
      border: none;
      background: var(--light);
      color: var(--text);
      cursor: pointer;
      font-weight: 600;
      transition: background .2s;
    }
    .form-switch button.active {
      background: var(--secondary);
      color: #fff;
    }
    .auth-input {
      width:100%;
      padding:.5rem;
      border:1px solid #dfe3e6;
      border-radius:6px;
      margin:.5rem 0;
    }
    .auth-link {
      display: block;
      margin-top: .75rem;
      text-align: center;
      font-size: .9rem;
      color: var(--secondary);
    }


    /* Toast */
    .toast{position:fixed;bottom:20px;right:20px;background:var(--success);color:#fff;padding:.7rem 1rem;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.25s;z-index:300}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Responsive */
    @media (max-width:960px){.grid-layout{grid-template-columns:1fr}}
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="topbar">
      <div class="brand">
        <!-- Using a placeholder image for better compliance -->
        <img src="https://placehold.co/40x40/3498db/ffffff?text=L%26F" alt="Muni L&F"/>
        <h1>Muni L&F Hub</h1>
      <div class="searchbar">
     <!-- Reduced width search box -->
      <input id="searchInput" type="text" placeholder="Search your lost and found items here" style="width:720px"/>
      <button id="searchBtn"><i class="fa fa-search"></i></button>
      </div>

<div class="userbox">
  
  <!-- "Help" button removed since "Help" is now in the main navigation bar -->
</div>

      <div class="userbox">
        <!-- Admin Dashboard Link is now hidden/removed as the management is inline -->
        <span id="userEmail" class="user-email"></span>
        <a href="#" id="logoutLink" class="btn" style="display:none;">Logout</a>
        <button id="openLoginModal" class="btn" style="background:var(--secondary);">Login / Sign up</button> 
      </div>
    </div>
  </header>

  <!-- Navigation Bar (Menu) - Replaces Categories bar -->
  <nav class="navbar">
    <div class="navwrap">
      <a href="#" class="nav-link">Home</a>
      <a href="#browse" class="nav-link">Browse Items</a>
      <a href="#report" class="nav-link">Report Item</a>
      <a href="#contact" class="nav-link">Contact Us</a>
      <a href="#help" class="nav-link">Help</a>
      <a href="#about" class="nav-link">About Us</a>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <h2 id="changingText">Did you find something on campus?</h2>
    <p>Browse like a marketplace, but for kindness. Report or claim items swiftly.</p>
    <a href="#report" class="cta">Report an item</a>
  </section>
  <!--item popup when clicked -->
    <div class="modal" id="itemModal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h2 id="modalTitle">Item Details</h2>
    <div id="modalContent"></div>
  </div>
</div>

  <!-- Main -->
  <main>
  <div class="grid-layout">
    <!-- Filters sidebar -->
    <aside class="filters">
      <h3>Filters</h3>
      <div class="group">
        <label for="filterType">Type</label>
        <select id="filterType">
          <option value="">All Types</option>
          <option>Electronics</option>
          <option>Books & Notes</option>
          <option>Clothing</option>
          <option>Accessories</option>
          <option>Keys</option>
          <option>ID Cards</option>
          <option>Water Bottles</option>
          <option>Bags & Backpacks</option>
          <option>Other</option>
        </select>
      </div>
      <div class="group">
        <label for="filterStatus">Status</label>
        <select id="filterStatus">
          <option value="">All Status</option>
          <option>Lost</option>
          <option>Found</option>
        </select>
      </div>
      <div class="group">
        <label for="sortBy">Sort by</label>
        <select id="sortBy">
          <option value="newest">Newest first</option>
          <option value="oldest">Oldest first</option>
          <option value="typeAsc">Type (A→Z)</option>
          <option value="typeDesc">Type (Z→A)</option>
          <option value="statusLost">Lost first</option>
          <option value="statusFound">Found first</option>
        </select>
      </div>
      <hr style="margin:1rem 0;opacity:.3"/>
      
      <!-- Report Item Form (Toggled by JS) -->
      <h3 id="reportTitle">Report item</h3>
      <p id="reportMessage" style="color:var(--accent); font-size:.9rem; text-align: center;">Please log in to report an item.</p>

      <form id="itemForm">
        <label for="itemTitle">Title</label>
        <input id="itemTitle" placeholder="Brief descriptive title (e.g., Blue iPhone 13)" required/>

        <label for="description" style="margin-top: .75rem; display: block;">Description</label>
        <textarea id="description" placeholder="Details: color, condition, where exactly it was found/lost." required></textarea>

        <label for="location" style="margin-top: .75rem; display: block;">Location</label>
        <input id="location" placeholder="Building, Room or Area" required/>

        <label for="date">Date</label>
        <input type="date" id="date" required/>

        <label for="contact" style="margin-top: .75rem; display: block;">Contact</label>
        <input id="contact" placeholder="Preferred contact (email/phone)" required/>

        <label for="itemType" style="margin-top: .75rem; display: block;">Item Type</label>
        <select id="itemType" required>
          <option value="">Item type</option>
          <option>Electronics</option>
          <option>Books & Notes</option>
          <option>Clothing</option>
          <option>Accessories</option>
          <option>Keys</option>
          <option>ID Cards</option>
          <option>Water Bottles</option>
          <option>Bags & Backpacks</option>
          <option>Other</option>
        </select>

        <label for="status" style="margin-top: .75rem; display: block;">Status</label>
        <select id="status" required>
          <option value="">Status</option>
          <option>Lost</option>
          <option>Found</option>
        </select>

        <label for="image" style="margin-top: .75rem; display: block;">Image (Optional)</label>
        <input type="file" id="image" accept="image/*"/>

        <button type="submit" class="btn" style="background:var(--secondary);color:#fff;width:100%;margin-top:1rem;">Submit for Review</button>
      </form>
    </aside>

    <!-- Right column -->
    <section>
      <!-- Sample showcase is retained but will be overwritten by live data -->
      <div id="homepage-samples" style="margin-bottom:2rem;">
        <h2 style="color:var(--primary);margin-bottom:1rem;">Latest Lost & Found</h2>
        <div class="items">
          <div class="card">
            <div class="thumb"><img src="https://placehold.co/240x170/3498db/ffffff?text=Found+Bottle" onerror="this.onerror=null; this.src='https://placehold.co/240x170/3498db/ffffff?text=Found+Bottle';" alt="Blue Hydro Flask"></div>
            <div class="info">
              <h4 class="title">Blue Hydro Flask</h4>
              <div class="meta"><span class="badge">Water Bottle</span><span class="badge status">Found</span></div>
              <p class="desc">Found near the library entrance with stickers.</p>
              <div class="actions"><span class="contact">library@muni.edu</span></div>
            </div>
          </div>
          <div class="card">
            <div class="thumb"><img src="https://placehold.co/240x170/e74c3c/ffffff?text=Lost+Book" onerror="this.onerror=null; this.src='https://placehold.co/240x170/e74c3c/ffffff?text=Lost+Book';" alt="Calculus Textbook"></div>
            <div class="info">
              <h4 class="title">Calculus Textbook</h4>
              <div class="meta"><span class="badge">Books & Notes</span><span class="badge status lost">Lost</span></div>
              <p class="desc">Lost between math building and student center.</p>
              <div class="actions"><span class="contact">john.doe@student.muni.edu</span></div>
            </div>
          </div>
          <div class="card">
            <div class="thumb"><img src="https://placehold.co/240x170/2ecc71/ffffff?text=Found+Tech" onerror="this.onerror=null; this.src='https://placehold.co/240x170/2ecc71/ffffff?text=Found+Tech';" alt="Wireless Earbuds"></div>
            <div class="info">
              <h4 class="title">Wireless Earbuds</h4>
              <div class="meta"><span class="badge">Electronics</span><span class="badge status">Found</span></div>
              <p class="desc">Black earbuds left on cafeteria table.</p>
              <div class="actions"><span class="contact">cafeteria@muni.edu</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Live items grid -->
      <div class="results-head">
        <div id="resultsMeta">0 items found</div>
      </div>
      <div id="itemsGrid" class="items"></div>
    </section>
  </div>
</main>


  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="box">
      <span class="close" id="closeLogin"><i class="fa fa-times"></i></span>
      <h3>Login to Muni L&F Hub</h3>
      <!-- Form Switch -->
      <div class="form-switch">
          <button id="switchToLogin" class="active">Login</button>
          <button id="switchToSignup">Sign Up</button>
      </div>
      
      <input id="loginEmail" class="auth-input" placeholder="Email" required/>
      <input id="loginPassword" class="auth-input" type="password" placeholder="Password" required/>
      
      <button id="loginBtn" class="btn" style="background:var(--secondary);color:#fff;width:100%;margin-top:.5rem">Log In</button>
      
      <a href="#" id="forgotPasswordLink" class="auth-link">Forgot Password?</a>
    </div>
  </div>

  <!-- Sign Up Modal -->
  <div class="modal" id="signupModal">
    <div class="box">
      <span class="close" id="closeSignup"><i class="fa fa-times"></i></span>
      <h3>Create an Account</h3>
      <!-- Form Switch -->
      <div class="form-switch">
          <button id="switchToLogin2">Login</button>
          <button id="switchToSignup2" class="active">Sign Up</button>
      </div>

      <p style="text-align:center;color:var(--text);font-size:.9rem;">*Standard user registration only. Admins must be registered manually.</p>
      
      <input id="signupEmail" class="auth-input" placeholder="Email (e.g., your@student.muni.edu)" required/>
      <input id="signupPassword" class="auth-input" type="password" placeholder="Password (min 6 characters)" required/>
      
      <button id="signupBtn" class="btn" style="background:var(--accent);color:#fff;width:100%;margin-top:.5rem">Sign Up</button>
      
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"><span id="toastMessage"></span></div>

  <!-- footer -->
  <footer style="background:var(--dark);color:#fff;padding:2rem;margin-top:2rem;">
  <div style="max-width:1200px;margin:0 auto;display:flex;flex-wrap:wrap;justify-content:space-between;gap:1rem;">
    <div>
      <h3 style="margin:0;color:var(--secondary)">Muni L&F Hub</h3>
      <p style="color:#bbb;font-size:.9rem;">&copy; 2025 Muni University. All rights reserved.</p>
    </div>
    <div style="display:flex;gap:1.5rem;flex-wrap:wrap;">
      <a href="#" style="color:#fff;">Home</a>
      <a href="#browse" style="color:#fff;">Browse Items</a>
      <a href="#report" style="color:#fff;">Report Item</a>
      <a href="#contact" style="color:#fff;">Contact Us</a>
      <a href="#help" style="color:#fff;">Help</a>
      <a href="#about" style="color:#fff;">About Us</a>
      <a href="#" style="color:#fff;">Privacy Policy</a>
    </div>
  </div>
</footer>


<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
  import { getFirestore, updateDoc, doc, collection, onSnapshot, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";

  // Hero rotation
  const messages=["Did you find something on campus?","Or lost something on campus?"];
  let mIndex=0;
  const changingText=document.getElementById("changingText");
  setInterval(()=>{mIndex=(mIndex+1)%messages.length;changingText.textContent=messages[mIndex];},5000);
  changingText.textContent=messages[mIndex];

  // Firebase init
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCWv1BfWQYMYmkLk3ydEpgwxhKo9pulO7Q",
    authDomain: "muni-lf-hub.firebaseapp.com",
    projectId: "muni-lf-hub",
    storageBucket: "muni-lf-hub.firebasestorage.app",
    messagingSenderId: "400377697268",
    appId: "1:400377697268:web:52726a678e8c19ee97dfa1",
    measurementId: "G-85THF0LN41"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app); 
  const storage = getStorage(app);
  
  // Admin email
  const ADMIN_EMAIL="admin@munilf.com";

  // Demo items (visible instantly) - Added isApproved:true for public visibility
  let demoItems=[
    {id:"demo1",type:"Water Bottles",status:"Found",title:"Blue Hydro Flask",description:"Found near library entrance.",location:"Main Library",date:"2025-10-15",contact:"library@muni.edu",image:"https://placehold.co/240x170/3498db/ffffff?text=Found+Bottle", createdBy:"demo@muni.edu", isApproved:true},
    {id:"demo2",type:"Books & Notes",status:"Lost",title:"Calculus Textbook",description:"Lost near math building.",location:"Math Building",date:"2025-10-14",contact:"john.doe@student.muni.edu",image:"https://placehold.co/240x170/e74c3c/ffffff?text=Lost+Book", createdBy:"demo@muni.edu", isApproved:true},
    {id:"demo3",type:"Electronics",status:"Found",title:"Wireless Earbuds",description:"Found black earbuds in cafeteria.",location:"Cafeteria",date:"2025-10-13",contact:"cafeteria@muni.edu",image:"https://placehold.co/240x170/2ecc71/ffffff?text=Found+Tech", createdBy:"demo@muni.edu", isApproved:true}
  ];

  // Refs
  const itemsGrid=document.getElementById("itemsGrid");
  const itemForm=document.getElementById("itemForm");
  const searchInput=document.getElementById("searchInput");
  const filterType=document.getElementById("filterType");
  const filterStatus=document.getElementById("filterStatus");
  const sortBy=document.getElementById("sortBy");
  const resultsMeta=document.getElementById("resultsMeta");
  const searchBtn=document.getElementById("searchBtn");
  const reportMessage=document.getElementById("reportMessage");

  // Auth Refs
  const loginModal=document.getElementById("loginModal");
  const signupModal=document.getElementById("signupModal");
  const openLoginModal=document.getElementById("openLoginModal");
  const closeLogin=document.getElementById("closeLogin");
  const closeSignup=document.getElementById("closeSignup");
  const loginEmail=document.getElementById("loginEmail");
  const loginPassword=document.getElementById("loginPassword");
  const signupEmail=document.getElementById("signupEmail");
  const signupPassword=document.getElementById("signupPassword");
  const loginBtn=document.getElementById("loginBtn");
  const signupBtn=document.getElementById("signupBtn");
  const userEmail=document.getElementById("userEmail");
  const logoutLink=document.getElementById("logoutLink");
  const forgotPasswordLink=document.getElementById("forgotPasswordLink");
  
  // Tab Switch Refs
  const switchToLogin=document.getElementById("switchToLogin");
  const switchToSignup=document.getElementById("switchToSignup");
  const switchToLogin2=document.getElementById("switchToLogin2");
  const switchToSignup2=document.getElementById("switchToSignup2");
  

  const toast=document.getElementById("toast");
  const toastMessage=document.getElementById("toastMessage");


  // Helpers
  function showToast(msg, isError = false){
    toastMessage.textContent=msg;
    toast.style.backgroundColor = isError ? "var(--accent)" : "var(--success)";
    toast.classList.add("show");
    setTimeout(()=>toast.classList.remove("show"),2500);
  }
  
  function isAdmin(u){return u && u.email===ADMIN_EMAIL;}
  // Authorization check: Admin can delete all, User can only delete their own
  function canDelete(u, item){return u && (isAdmin(u) || item.createdBy===u.email);}
  function fmtDate(d){try{const o={year:"numeric",month:"short",day:"numeric"};return new Date(d).toLocaleDateString(undefined,o);}catch{return d}}
  
  function showModal(modalId){
    // Hide all auth modals first
    [loginModal, signupModal].forEach(m => m.style.display = 'none');
    // Show the desired modal
    const modal = document.getElementById(modalId);
    if(modal) modal.style.display = 'flex';
  }
  
  function requireAuth(cb){
    const u=auth.currentUser;
    if(u) cb();
    else {
      showToast("You must be logged in to perform this action.", true);
      showModal("loginModal"); // Show login if not authenticated
    }
  }


  // --- Auth Event Listeners (Login/Signup Pop-ups) ---

  openLoginModal.onclick=()=>showModal("loginModal");
  closeLogin.onclick=()=>loginModal.style.display="none";
  closeSignup.onclick=()=>signupModal.style.display="none";
  
  window.addEventListener("click",(e)=>{
    if(e.target===loginModal) loginModal.style.display="none";
    if(e.target===signupModal) signupModal.style.display="none";
  });
  
  // Tab/Switching logic
  switchToSignup.onclick = () => showModal("signupModal");
  switchToLogin.onclick = () => showModal("loginModal");
  switchToSignup2.onclick = () => showModal("signupModal");
  switchToLogin2.onclick = () => showModal("loginModal");

  // Firebase Auth State Listener
  auth.onAuthStateChanged(user=>{
    if(user){
      userEmail.textContent=`Hello, ${user.email.split('@')[0]}`; // Show part of email
      logoutLink.style.display="inline";
      openLoginModal.style.display = 'none';

      // Show/Hide Report Form
      itemForm.style.display = 'block';
      reportMessage.style.display = 'none';

      if(isAdmin(user)){
        showToast("Logged in as Admin!");
      }

    }
    else{
      userEmail.textContent="";
      logoutLink.style.display="none";
      openLoginModal.style.display = 'inline-block';

      // Show/Hide Report Form
      itemForm.style.display = 'none';
      reportMessage.style.display = 'block';
    }
    applyFiltersAndRender();
  });

  // User Sign Up
  signupBtn.onclick=()=>{
    const email=signupEmail.value.trim(), pw=signupPassword.value;
    if(!email||!pw) return showToast("Provide email and password.", true);
    if(email === ADMIN_EMAIL) return showToast("Admin accounts cannot be created via the public sign-up form.", true);

    auth.createUserWithEmailAndPassword(email,pw)
      .then(()=>{
        showToast("Registration successful! Please log in.");
        showModal("loginModal");
      })
      .catch(err=>showToast(err.message, true));
  };
  
  // User/Admin Login
  loginBtn.onclick=()=>{
    const email=loginEmail.value.trim(), pw=loginPassword.value;
    if(!email||!pw) return showToast("Provide email and password.", true);
    
    auth.signInWithEmailAndPassword(email,pw)
      .then(()=>{
        showToast("Logged in successfully!");
        loginModal.style.display="none";
      })
      .catch(err=>showToast(err.message, true));
  };
  
  // Forgot Password
  forgotPasswordLink.onclick=(e)=>{
    e.preventDefault();
    const email = loginEmail.value.trim();
    if (!email) {
        showToast("Please enter your email in the login form first.", true);
        return;
    }
    
    auth.sendPasswordResetEmail(email)
      .then(() => {
        showToast("Password reset link sent to your email.");
      })
      .catch(err => {
        showToast(err.message, true);
      });
  }

  // Logout
  logoutLink.onclick=(e)=>{
    e.preventDefault();
    auth.signOut().then(()=>showToast("Logged out"));
  };

  // --- End Auth Event Listeners ---


  // Firestore live items
  let liveItems=[];
  
  // FIX: Use modular onSnapshot and collection functions with the 'db' variable
  onSnapshot(collection(db, "items"), snap=>{
    liveItems=snap.docs.map(d=>({id:d.id,...d.data()}));
    applyFiltersAndRender();
  });

  // Search/filter/sort
  searchInput.oninput=applyFiltersAndRender;
  searchBtn.onclick=applyFiltersAndRender;
  filterType.onchange=applyFiltersAndRender;
  filterStatus.onchange=applyFiltersAndRender;
  sortBy.onchange=applyFiltersAndRender;

  // Render pipeline (updated for admin/approval logic)
  function applyFiltersAndRender(){
    const term=(searchInput.value||"").toLowerCase();
    const type=filterType.value||"";
    const status=filterStatus.value||"";
    const sort=sortBy.value||"newest";
    const u=auth.currentUser;
    const isUserAdmin = isAdmin(u);

    let all=[...demoItems,...liveItems];

    // --- NEW: Approval Filtering Logic ---
    all=all.filter(i=>{
      // Admins see all items
      if(isUserAdmin) return true;
      // Standard users see approved items OR items they created
      return i.isApproved === true || i.createdBy === u?.email;
    });

    // Filter by search term, type, and status
    all=all.filter(i=>{
      const t=(i.title||"").toLowerCase(), d=(i.description||"").toLowerCase(), l=(i.location||"").toLowerCase();
      const matchesTerm = t.includes(term) || d.includes(term) || l.includes(term);
      const matchesType = !type || i.type===type;
      const matchesStatus = !status || i.status===status;
      return matchesTerm && matchesType && matchesStatus;
    });

    // Sort
    all.sort((a,b)=>{
      const ad=new Date(a.date).getTime()||0, bd=new Date(b.date).getTime()||0;
      if(sort==="newest") return bd-ad;
      if(sort==="oldest") return ad-bd;
      if(sort==="typeAsc") return (a.type||"").localeCompare(b.type||"");
      if(sort==="typeDesc") return (b.type||"").localeCompare(a.type||"");
      if(sort==="statusLost") return (a.status==="Lost"?-1:1);
      if(sort==="statusFound") return (a.status==="Found"?-1:1);
      return 0;
    });

    // Render
    renderItems(all);
  }

  function renderItems(items){
    itemsGrid.innerHTML="";
    const u=auth.currentUser;
    const isUserAdmin = isAdmin(u);
    resultsMeta.textContent=`${items.length} item${items.length===1?"":"s"} found`;

    if(!items.length){
      itemsGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;padding:2rem;">No items found. Try adjusting filters.</p>';
      return;
    }

    items.forEach(item=>{
      const isPending = item.isApproved !== true; // Check if pending approval
      const isOwner = item.createdBy === u?.email;
      
      const card=document.createElement("div");
      card.className="card";
      
      let overlayHTML = '';
      if(isPending){
        overlayHTML = `
          <div class="unapproved-overlay">
            <i class="fa fa-clock" style="font-size: 2rem;"></i>
            ${isOwner ? '<p>Awaiting Admin Review</p>' : '<p>ITEM PENDING REVIEW</p>'}
            ${isUserAdmin && !isOwner ? '<button class="btn btn-approve" data-id="'+item.id+'">Approve Item</button>' : ''}
          </div>
        `;
      }

      card.innerHTML=`
        ${overlayHTML}
        <div class="thumb"><img src="${item.image||'https://placehold.co/240x170/3498db/ffffff?text=Image+Missing'}" alt="${item.title}" onerror="this.onerror=null; this.src='https://placehold.co/240x170/3498db/ffffff?text=Image+Missing';"/></div>
        <div class="info">
          <h4 class="title">${item.title}</h4>
          <div class="meta">
            <span class="badge">${item.type||"Unknown"}</span>
            <span class="badge status ${item.status==='Lost'?'lost':''}">${item.status||"Unknown"}</span>
            <span class="badge">${fmtDate(item.date||new Date().toISOString())}</span>
            <span class="badge" style="color:var(--primary)">By: ${item.createdBy.split('@')[0]}</span>
          </div>
          <p class="desc">${(item.description||"").slice(0,140)}${(item.description||"").length>140?"...":""}</p>
          <div class="actions">
            <span class="contact">${item.contact||"No contact"}</span>
            <div style="display:flex;gap:.4rem">
              <!-- Contact button is only shown if item is approved (or if user is admin) -->
              ${(!isPending || isUserAdmin) ? '<button class="btn btn-contact-finder">'+(item.status==='Found'?'Claim':'Contact Finder')+'</button>' : ''}
              ${canDelete(u,item)?'<button class="btn btn-delete">Delete</button>':''}
            </div>
          </div>
        </div>
      `;

      // Claim/contact
      card.querySelector(".btn-contact-finder")?.addEventListener('click', (e) => {
        e.stopPropagation();
        requireAuth(() => showToast(`Contact details: ${item.contact||"Unavailable"}`));
      });
      
      // Admin Approve Button Logic
      const btnApprove = card.querySelector(".btn-approve");
      if (btnApprove) {
        btnApprove.onclick = async (e) => {
          e.stopPropagation();
          if(!isUserAdmin) return showToast("Only admins can approve items.", true);
          try {
            if (String(item.id).startsWith("demo")) {
              // Mark demo item as approved in local list
              const demoItem = demoItems.find(d => d.id === item.id);
              if(demoItem) demoItem.isApproved = true;
            } else {
              // Update firestore item
              const itemRef = doc(db, "items", item.id);
              await updateDoc(itemRef, { isApproved: true });
            }
            showToast("Item approved successfully!");
            // Rerender to reflect changes
            applyFiltersAndRender(); 
          } catch(err) {
            showToast("Error approving item: " + err.message, true);
          }
        };
      }

      // Delete (admin or owner)
      const del=card.querySelector(".btn-delete");
      if(del){
        del.onclick=async (e)=>{
          e.stopPropagation();
          if(!canDelete(u,item)) return showToast("Not authorized.", true);
          if(confirm("Are you sure you want to permanently delete this item?")){
            try{
              if(String(item.id).startsWith("demo")){
                demoItems=demoItems.filter(d=>d.id!==item.id);
                applyFiltersAndRender();
              }else{
                // FIX: Use modular deleteDoc and doc with 'db' variable
                await deleteDoc(doc(db, "items", item.id));
              }
              showToast("Item deleted");
            }catch(err){showToast(err.message, true);}
          }
        };
      }

      itemsGrid.appendChild(card);
    });
  }

  // Form submit: image upload + create
  document.getElementById("date").valueAsDate=new Date();
  itemForm.onsubmit=async (e)=>{
    e.preventDefault();
    requireAuth(async ()=>{
      try{
        const u=auth.currentUser;
        const isUserAdmin = isAdmin(u);
        const file=document.getElementById("image").files[0];
        let imageUrl="";
        if(file){
          // FIX: Use modular ref, uploadBytes, and getDownloadURL with 'storage' variable
          const storageReference = ref(storage, `items/${Date.now()}_${file.name}`);
          const snapshot = await uploadBytes(storageReference, file);
          imageUrl = await getDownloadURL(snapshot.ref);
        }
        const newItem={
          type:document.getElementById("itemType").value,
          status:document.getElementById("status").value,
          title:document.getElementById("itemTitle").value,
          description:document.getElementById("description").value,
          location:document.getElementById("location").value,
          date:document.getElementById("date").value,
          contact:document.getElementById("contact").value,
          image:imageUrl,
          createdBy:u.email,
          // NEW: Only set to true if submitted by admin, otherwise pending review
          isApproved: isUserAdmin 
        };
        
        // FIX: Use modular addDoc and collection with 'db' variable
        await addDoc(collection(db, "items"), newItem); 
        
        if(isUserAdmin){
            showToast("Admin item reported and approved successfully!");
        } else {
            showToast("Item submitted for admin review. It will appear publicly once approved.");
        }
        itemForm.reset();
        document.getElementById("date").valueAsDate=new Date();
      }catch(err){showToast(err.message, true);}
    });
  };
</script>
</body>
</html>